<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Data Visualization</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        .loader {
            border: 16px solid #00000000; /* Light grey */
            border-top: 16px solid #3498db; /* Blue */
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        .form-button-confirm:hover {
            background-color: rgb(103, 209, 255);
        }
        .form-button-cancel:hover {
            background-color: #ff7e67;
        }

        .highlight {
            background-color:rgb(59 130 246); /* 你可以选择你喜欢的颜色 */
        }


    </style>


    <script>
        function close_loader(){
            loader = document.getElementsByClassName('loader')[0];
            loader.style.display = 'none';
        }

        function open_loader(){
            loader = document.getElementsByClassName('loader')[0];
            loader.style.display = 'block';
        }

        function drawChart(date, data_) {
            var myChart = echarts.init(document.getElementById('main'));
            const upColor = '#ec0000';
            const upBorderColor = '#8A0000';
            const downColor = '#00da3c';
            const downBorderColor = '#008F28';
            var option = {
                dataset: {
                    source: data_
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                    type: 'line'
                    }
                },
                toolbox: {
                    feature: {
                    dataZoom: {
                        yAxisIndex: false
                    }
                    }
                },
                grid: [
                    {
                    left: '10%',
                    right: '10%',
                    bottom: 200
                    },
                    {
                    left: '10%',
                    right: '10%',
                    height: 80,
                    bottom: 80
                    }
                ],
                xAxis: [
                    {
                    type: 'category',
                    boundaryGap: false,
                    // inverse: true,
                    axisLine: { onZero: false },
                    splitLine: { show: false },
                    min: 'dataMin',
                    max: 'dataMax'
                    },
                    {
                    type: 'category',
                    gridIndex: 1,
                    boundaryGap: false,
                    axisLine: { onZero: false },
                    axisTick: { show: false },
                    splitLine: { show: false },
                    axisLabel: { show: false },
                    min: 'dataMin',
                    max: 'dataMax'
                    }
                ],
                yAxis: [
                    {
                    scale: true,
                    splitArea: {
                        show: true
                    }
                    },
                    {
                    scale: true,
                    gridIndex: 1,
                    splitNumber: 2,
                    axisLabel: { show: false },
                    axisLine: { show: false },
                    axisTick: { show: false },
                    splitLine: { show: false }
                    }
                ],
                dataZoom: [
                    {
                    type: 'inside',
                    xAxisIndex: [0, 1],
                    start: 10,
                    end: 100
                    },
                    {
                    show: true,
                    xAxisIndex: [0, 1],
                    type: 'slider',
                    bottom: 10,
                    start: 10,
                    end: 100
                    }
                ],
                visualMap: {
                    show: false,
                    seriesIndex: 1,
                    dimension: 6,
                    pieces: [
                    {
                        value: 1,
                        color: upColor
                    },
                    {
                        value: -1,
                        color: downColor
                    }
                    ]
                },
                series: [
                    {
                    type: 'candlestick',
                    itemStyle: {
                        color: upColor,
                        color0: downColor,
                        borderColor: upBorderColor,
                        borderColor0: downBorderColor
                    },
                    encode: {
                        x: 0,
                        y: [1, 4, 3, 2]
                    }
                    },
                    {
                    name: 'Volumn',
                    type: 'bar',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    itemStyle: {
                        color: '#7fbe9e'
                    },
                    large: true,
                    encode: {
                        x: 0,
                        y: 5
                    }
                    }
                ]
                };
            myChart.setOption(option);
        }

        function drawforecast(data, element){
            var myChart = echarts.init(element);
            var option = {
                xAxis: {
                    type: 'category',
                    //data: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]
                },
                yAxis: {
                    type: 'value'
                },
                series: [
                    {
                    data: data,
                    type: 'line'
                    }
                ]
                };
            myChart.setOption(option);
        }


        function getInputValues(id) {
            // 获取指定id下的所有input元素 和 select元素
            var inputs = document.getElementById(id).querySelectorAll('input');
            var selects = document.getElementById(id).querySelectorAll('select');
            inputs = [...inputs, ...selects]
            var result = {};
            for (var i = 0; i < inputs.length; i++) {
                result[inputs[i].name] = Number(inputs[i].value);
            }
            return result;
        }

        var state_of_model = ["否决", "通过", "待命"];
        var state_of_model_color = ["bg-red-100", "bg-green-100", "bg-gray-100"];

        window.onload = function(){
                   // 为start按钮绑定事件
            document.getElementById("start").onclick = function() {
                // 打开加载动画
                open_loader();
                // 获取股票编号
                var stock_id = document.getElementById("stock_id").value;
                // 获取模型选择
                var model1 = document.getElementById("model1").checked;
                var model1conf = getInputValues("model1conf");


                var model2 = document.getElementById("model2").checked;
                var model2conf = getInputValues("model2conf");

                var model3 = document.getElementById("model3").checked;
                var model3conf = getInputValues("model3conf");

                var model4 = document.getElementById("model4").checked;
                var model4conf = getInputValues("model4conf");

                var model5 = document.getElementById("model5").checked;
                var model5conf = getInputValues("model5conf");
                // 发送请求
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/predict", true);
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.send(JSON.stringify({
                    "stock_id": stock_id,
                    "model1": model1,
                    "model1conf": model1conf,
                    "model2": model2,
                    "model2conf": model2conf,
                    "model3": model3,
                    "model3conf": model3conf,
                    "model4": model4,
                    "model4conf": model4conf,
                    "model5": model5,
                    "model5conf": model5conf,
                }));
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        // 获取返回的数据
                        var data = JSON.parse(xhr.responseText);
                        
                        // 更新模型状态
                        if (data.model1 != 2){
                            document.getElementById("model1_state").innerHTML = state_of_model[data.model1];
                            document.getElementById("model1_state").classList.add(state_of_model_color[data.model1]);
                            drawforecast(data.model1_forecast, document.getElementById("ans1"));
                        }

                        if (data.model2 != 2){
                            document.getElementById("model2_state").innerHTML = state_of_model[data.model2];
                            document.getElementById("model2_state").classList.add(state_of_model_color[data.model2]);
                            drawforecast(data.model2_forecast, document.getElementById("ans2"));
                        }

                        if (data.model3 != 2){
                            document.getElementById("model3_state").innerHTML = state_of_model[data.model3];
                            document.getElementById("model3_state").classList.add(state_of_model_color[data.model3]);
                            drawforecast(data.model3_forecast, document.getElementById("ans3"));
                        }

                        if (data.model4 != 2){
                            document.getElementById("model4_state").innerHTML = state_of_model[data.model4];
                            document.getElementById("model4_state").classList.add(state_of_model_color[data.model4]);
                            drawforecast(data.model4_forecast, document.getElementById("ans4"));
                        }

                        if (data.model5 != 2){
                            document.getElementById("model5_state").innerHTML = state_of_model[data.model5];
                            document.getElementById("model5_state").classList.add(state_of_model_color[data.model5]);
                            drawforecast(data.model5_forecast, document.getElementById("ans5"));
                        }



                        // 更新统计结果
                        document.getElementById("ans").innerHTML = "通过率为:" + data.ans*100 + "%";

                        // 绘制图表
                        drawChart(data.date, data.data);
                        // 关闭加载动画
                        close_loader();
                    }
                }
            }
        }

 





    </script>


</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <div class="grid gap-4">
            <!-- Stock Data Chart -->
            <div class="bg-white shadow rounded p-4" >
                <h2 class="text-xl font-semibold mb-4">股票数据图</h2>
                <!-- Placeholder for chart -->
                <div class="bg-gray-200 rounded flex items-center justify-center" style="height: 600px;" id="main"></div>
            </div>
        </div>


        <!-- Models Selection -->
        <div class="bg-white shadow rounded p-4 mt-4">
            <div class="grid grid-cols-3 gap-4">
                <div class="col-span-2">
                    <h3 class="text-lg font-semibold mb-2">模型选择</h3>
                    <div class="space-y-2">
                        <!-- Model 1 -->
                        <div class="flex items-center">
                            <input type="checkbox" id="model1" class="mr-2" checked>
                            <label for="model1">支持向量机模型</label>
                            <div class="bg-gray-100 rounded-full px-2 py-1 ml-2 text-xs text-gray-600" id="model1_state">待命</div>
                        </div>
                        <!-- Model 2 -->
                        <div class="flex items-center">
                            <input type="checkbox" id="model2" class="mr-2" checked>
                            <label for="model2">移动平均线模型</label>
                            <div class="bg-gray-100 rounded-full px-2 py-1 ml-2 text-xs text-gray-600" id="model2_state">待命</div>
                        </div>
                        <!-- Model 3 -->
                        <div class="flex items-center">
                            <input type="checkbox" id="model3" class="mr-2" checked>
                            <label for="model3">长短期时间序列预测模型</label>
                            <div class="bg-gray-100 rounded-full px-2 py-1 ml-2 text-xs text-gray-600" id="model3_state">待命</div>
                        </div>
                        <!-- Model 4 -->
                        <div class="flex items-center">
                            <input type="checkbox" id="model4" class="mr-2" checked>
                            <label for="model4">自我回归模型</label>
                            <div class="bg-gray-100 rounded-full px-2 py-1 ml-2 text-xs text-gray-600" id="model4_state">待命</div>
                        </div>
                        <!-- Model 5 -->
                        <div class="flex items-center">
                            <input type="checkbox" id="model5" class="mr-2" checked>
                            <label for="model5">证券技术改良后的朴素法</label>
                            <div class="bg-gray-100 rounded-full px-2 py-1 ml-2 text-xs text-gray-600" id="model5_state">待命</div>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2">股票编号</h3>
                    <input type="text" placeholder="请输入股票编号" class="border border-gray-300 rounded p-2 w-full" id="stock_id" value="000001.SZ">
                            <div class="flex justify-end mt-4">
                                <button id="start" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                                    开始预测
                                </button>
                            </div>
                    <div class="">
                        统计结果：<h1 id="ans"></h1>
                    </div>
                </div>

                

            </div>
        </div>

        <!-- Prediction Button -->


        <div id = model1conf class="bg-white shadow rounded p-4 mt-4 flex justify-between h-96">
            <div class="w-1/2">
                <h3 class="text-lg font-semibold mb-2">支持向量机模型配置</h3>

                <input type="text" placeholder="输入学习率" name="study_rate" value="0.8" class="border border-gray-300 rounded p-2 w-1/3">
                <label>学习率</label>
                <br>

                <input type="text" placeholder="输入训练集占比" name="trainingsize" value="0.8" class="border border-gray-300 rounded p-2 w-1/3">
                <label>训练集占比</label>
                <br>
                
                
            </div>
            <div id = "ans1" class="w-1/2 bg-gray-100"></div>

        </div>

        <div id = model2conf class="bg-white shadow rounded p-4 mt-4 flex justify-between h-96">
            <div class="w-1/2">
                <h3 class="text-lg font-semibold mb-2">移动平均线模型</h3>

                <input type="text" placeholder="输入学习率" name="study_rate" value="0.8" class="border border-gray-300 rounded p-2 w-1/3">
                <label>学习率</label>                
                <br>

                <input type="text" placeholder="输入训练集占比" name="trainingsize" value="0.8" class="border border-gray-300 rounded p-2 w-1/3">
                <label>训练集占比</label>  
                <br>
                
                
            </div>
            <div id = "ans2" class="w-1/2 bg-gray-100"></div>

        </div>

        <div id = model3conf class="bg-white shadow rounded p-4 mt-4 flex justify-between h-96">
            <div class="w-1/2">
                <h3 class="text-lg font-semibold mb-2">长短期时间序列预测模型</h3>

                <input type="text" name="seq_len" value="50" class="border border-gray-300 rounded p-2 w-1/3" title="注意:并非越大越好,控制在1-100内" pattern="\d+">
                <label>序列长度</label>
                <br>

                <input type="text" name="nero_num" value="100" class="border border-gray-300 rounded p-2 w-1/3" title="表示模型复杂程度，与消耗时间正比，过大的数值不一定会对精度产生明显正向影响">
                <label>LSTM神经元个数</label>
                <br>

                <input type="text" name="dropout_rate" value="0.2" class="border border-gray-300 rounded p-2 w-1/3" title="表示对信息的遗忘阈值，越大短期信息影响时间越长">
                <label>drop out率</label>                
                <br>

                <input type="text" name="train_test_split" value="0.8" class="border border-gray-300 rounded p-2 w-1/3">
                <label>训练集占比</label>
                <br>



            </div>
            <div id = "ans3" class="w-1/2 bg-gray-100"></div>

        </div>

        <div id = model4conf class="bg-white shadow rounded p-4 mt-4 flex justify-between h-96">
            <div class="w-1/2">
                <h3 class="text-lg font-semibold mb-2">自我回归模型</h3>

                <select type="text" name="autoregression_type" value="0.8" class="border border-gray-300 rounded p-2 w-1/3">
                    <option value="0">使用第一项</option>
                    <option value="1">使用第二项</option>
                </select>
                <label>自回归项</label>
                <br>

                <select type="text" placeholder="输入训练集占比" name="difference_type" value="0.8" class="border border-gray-300 rounded p-2 w-1/3">
                    <option value="0">使用第一项</option>
                    <option value="1">使用第二项</option>
                </select>
                <label>差分项</label>
                <br>
                
                <select type="text" name="moveaverage_type" value="0.8" class="border border-gray-300 rounded p-2 w-1/3">
                    <option value="0">使用第一项</option>
                    <option value="1">使用第二项</option>
                </select>
                <label>移动平均项</label>
                <br>

                <input type="text" name="study_rate" value="0.8" class="border border-gray-300 rounded p-2 w-1/3">
                <label>训练集占比</label>
                <br>
                
            </div>
            <div id = "ans4" class="w-1/2 bg-gray-100"></div>

        </div>

        <div id = model5conf class="bg-white shadow rounded p-4 mt-4 flex justify-between h-96">
            <div class="w-1/2">
                <h3 class="text-lg font-semibold mb-2">证券技术改良后的朴素法</h3>

                <input type="text" placeholder="输入训练集占比" name="traning_rate" value="0.8" class="border border-gray-300 rounded p-2 w-1/3">
                <label>训练集占比</label>
                <br>
                
            </div>
            <div id = "ans5" class="w-1/2 bg-gray-100"></div>

        </div>


    </div>
    <div class="loader fixed items-center bottom-0" style="display: none;"></div> 

</body>
</html>